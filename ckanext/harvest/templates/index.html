{% extends "page.html" %}

{% block title %}Harvesting Sources - {{ super() }}{% endblock %}


{% block optional_head %}
    <link type="text/css" rel="stylesheet" media="all" href="/ckanext/harvest/style.css" />
{% endblock %}

{% block breadcrumb_content %}
    <li><a href="/data/search">Datasets</a></li>
    <li><a href="/harvest">Harvest sources</a></li>
{% endblock %}

{% macro harvest_source_table(sources, can_edit) %}
       <table id="harvest-sources" class="table table-bordered publishers" >
        <tr>
            <th></th>
            <th>URL</th>
            <th>Type</th>
            <th>Active</th>
            <th>Created</th>
        </tr>
        {% set old_publisher=None%}
        {% set sources=sources%}
        {% if not can_edit%}
          {% set sources=h.get_active_sources(sources) %}
        {% endif %}
        {% for source in sources %}
            {% if old_publisher!=source['publisher_id']%}
            <tr class="publisher">
                {% if source.get('publisher_title')%}
                  <td colspan="9">{{source['publisher_title']}}</td>
                {% else %}
                  <td colspan="9">{{source['publisher_id']}}</td>
                {% endif %}
            </tr>
            {% endif %}
            {% set old_publisher=source['publisher_id']  %}
            <tr class="{% if source.active%}active{% else%}inactive{% endif%}}">
                <td align="center">
                  <a href="/harvest/{{source.name or source.id}}">View</a>&nbsp;&nbsp;
                  {% if h.check_access('harvest_source_update', {'id':source.id}) %}
                    <a href="harvest/edit/{{source.name or source.id}}">Edit</a>&nbsp;&nbsp;
                  {% endif %}
                  {%  if h.check_access('harvest_job_create', {'source_id':source.id})%}
                    <a  href="harvest/refresh/{{source.name or source.id}}">Refresh</a>
                  {% endif %}
                </td>
                <td title="{{source.url}}">{{h.truncate(source.url, 60)}}</td>
                <td>{{source.type}}</td>
                <td class="state">{{source.active}}</td>
                <td>{{h.render_datetime(source.created)}}</td>
             </tr>
         {% endfor %}
    </table>
  {% endmacro %}

{% set can_edit=h.check_access('harvest_source_create') %}
{% set org_ids=h.get_org_ids() %}

{% block primary_content_inner %}
  <div>

      {% if can_edit %}
      <a class="btn btn-primary pull-right" id="xnew-harvest-source" href="harvest/new">
          <i class="icon-plus"></i>
          Add a harvesting source
      </a>
      {% endif %}

      <h1>Harvesting sources</h1>

      <div class="harvest-content boxed">
        {% if can_edit and c.status %}
        <div class="status">
          <h3>Status:</h3>
          {{h.literal(c.status)}}
        </div>
        {% endif %}

        {% if org_ids %}
        <div>
            {% if can_edit %}
            <div id="show-inactive-sources-content">
              <input type="checkbox" id="show-inactive-sources" />
              <label for="show-inactive-sources"> Show inactive sources</label>
            </div>
            {% endif %}
            <h3>My organizations</h3>
            {{harvest_source_table(h.allowed_sources(org_ids), can_edit)}}
        </div>
        {% endif %}
        {% if c.sources %}
            {% if can_edit %}
            <div id="show-inactive-sources-content">
              <input type="checkbox" id="show-inactive-sources" />
              <label for="show-inactive-sources"> Show inactive sources</label>
            </div>
            {% endif %}
            <h3>All organizations</h3>
            {{harvest_source_table(c.sources, can_edit)}}
        {% else %}
              <div id="no-harvest-sources">No harvest sources defined yet.</div>
        {% endif %}
  </div>
</div>


{% endblock%}

{% block optional_footer %}
      <script>$("#show-inactive-sources").click(function(){$("#harvest-sources .inactive").toggle()});</script>
{% endblock%}

