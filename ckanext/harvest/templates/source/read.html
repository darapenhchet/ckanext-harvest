<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <py:def function="page_title">Harvest Source Details</py:def>

  <py:def function="optional_head">
    <link type="text/css" rel="stylesheet" media="all" href="/ckanext/harvest/style.css" />
  </py:def>

<py:match path="breadcrumbs">
    <li><a href="/data/search">Datasets</a></li>
    <li><a href="/harvest">Harvest sources</a></li>
    <li><a href="/harvest/${c.source.name or c.source.id}">${c.source.title}</a></li>
  </py:match>

<div py:match="content">
  <div class="harvest-content boxed">
  <py:if test="c.source">
  <h1>Harvest Source</h1>
  <div id="harvest-source-actions">
  <a py:if="h.check_access('harvest_source_update', {'id':c.source.id})" class="btn btn-primary" href="/harvest/edit/${c.source.name or c.source.id}">
    <i class="icon-edit"></i>
    Edit source
  </a>
  <a py:if="h.check_access('harvest_job_create', {'source_id':c.source.id})" class="btn btn-primary" py:attrs="{} if c.source.active else {'disabled': 'disabled'}" href="/harvest/refresh/${c.source.name or c.source.id}">
    <i class="icon-refresh"></i>
    Refresh source
  </a>

    </div>
    <div py:if="not c.source.active" class="alert alert-block">NB: This Harvest Source is Inactive. Therefore its metadata will not be harvested again. However, any records that were previously harvested remain in the catalogue.</div>
    <table id="harvest-source-details" class="table table-bordered table-condensed" py:with="job_detail = h.check_access('harvest_job_create', {'source_id':c.source.id})">
        <tr py:if="job_detail and not c.source.name">
            <th>ID</th>
            <td>${c.source.id}</td>
        </tr>
        <tr>
            <th>URL</th>
            <td>${c.source.url}</td>
        </tr>
        <tr>
            <th>Type</th>
            <td>${c.source.type}</td>
        </tr>
        <tr>
            <th>Update Frequency</th>
            <td>${(c.source.frequency or '').capitalize()}</td>
        </tr>
        <tr py:if="job_detail">
            <th>Active</th>
            <td>${c.source.active}</td>
        </tr>
        <tr py:if="c.source.title">
            <th>Title</th>
            <td>${c.source.title}</td>
        </tr>

        <tr>
            <th>Description</th>
            <td>${c.source.description}</td>
        </tr>
        <tr>
            <th>Configuration</th>
            <py:if test="c.source.config">
            <td>${c.source.config}</td>
            </py:if>
            <py:if test="not c.source.config">
            <td>-</td>
            </py:if>
        </tr>
        <tr py:if="job_detail" style="display: none">
            <th>User</th>
            <td>${c.source.user_id}</td>
        </tr>
        <tr>
            <th>Publisher</th>
            <td>
              <py:if test="c.source.publisher_title">
                <a href="${h.url('organization_read', id=c.source.publisher_name)}">
                  ${c.source.publisher_title}
                </a>
              </py:if>
              <py:if test="not c.source.publisher_title">
                  ${c.source.publisher_id}
              </py:if>
            </td>
        </tr>
        <tr>
            <th>Created</th>
            <td>${h.render_datetime(c.source.created, with_hours=True)}</td>
        </tr>
        <py:if test="job_detail">
        <tr>
            <th>Total harvests</th>
            <td>${c.source.status.job_count}</td>
        </tr>
        <tr class="harvest-status">
            <th>Status</th>
            <td>
             <py:if test="c.source.status.running_job or c.source.status.last_job">
              <p py:if="c.source.status.running_job">
                <strong>
                  Harvesting in progress: ${h.literal(c.source.status.running_job)}<br/>
                </strong>
              </p>
              <p py:if="not c.source.status.running_job">
                Last Harvest: <br/>
              </p>
              Date: ${h.render_datetime(c.source.status.last_job.created, with_hours=True)} <br/>
              <py:if test="c.source.status.last_job">

                Harvest
                <py:if test="not c.source.status.running_job">
                  complete
                </py:if>
                - 
                <py:if test="not c.source.status.last_job.stats.get('errored')">
                  <a name="errors"/>no errors
                </py:if>
                <py:if test="c.source.status.last_job.stats.get('errored')">
                  <a name="errors"/>Errors: ${c.source.status.last_job.stats.get('errored', 0)}
                </py:if>
                <py:if test="c.source.status.running_job">
                  so far
                </py:if>
                <br/>

                <py:choose>
                    <py:when test="len(c.source.status.last_job.gather_errors)>0">
                        <i>Gathering errors</i>
                        <ul>
                        <li py:for="error in c.source.status.last_job.gather_errors">
                            <?python
                                lines = error.get('message', '').split('\n')
                            ?>
                            <div py:for="line in lines" class="message">${line}</div>
                        </li>
                        </ul>
                    </py:when>
                </py:choose>
                <py:choose>
                    <py:when test="len(c.source.status.last_job.object_errors)>0">
                        <i>Object errors</i>
                        <ul>
                        <li py:for="error in c.source.status.last_job.object_errors">
                            <div class="message">Harvest of GUID <a href="/harvest/object/${error.harvest_object_id}">${error.object.guid}</a></div>
                            <div py:for="section in error.message.split('\n\n')" class="message-section">
                              <div py:for="line in section.split('\n')" class="message">
                                ${line}
                              </div>
                            </div>
                        </li>
                        </ul>
                    </py:when>
                </py:choose>
                <!-- Not displaying these numbers as they are confusing - see notes below. -->
                <span style="display:None">
                 Harvested records:
                  <!-- NB this will all be zero if there are no HarvestObjects - i.e. if the harvester is designed to do everything in the gather stage. Or if the gather stage can see that none of the records have updated since the last harvest and therefore no objects needed. And datasets that were updated with state=deleted are shown as 'reimported' yet don't appear in the list of datasets.-->
                  <py:for each="result in ['new', 'reimported', 'errored']">
                    ${result}: ${c.source.status.last_job.stats.get(result, 0)}
                  </py:for>
                  <py:for each="result in ['deleted', 'unchanged']">
                    <!--! 'unchanged' only used if the fetch checks if an update is necessary or not. Many harvesters may always update. So we only display these fields if there is a value. -->
                    <py:if test="c.source.status.last_job.stats.get(result)">
                      ${result}: ${c.source.status.last_job.stats.get(result, 0)}
                    </py:if>
                  </py:for>
                  <br/>
                </span>
              </py:if>
             </py:if>
             <py:if test="not (c.source.status.running_job or c.source.status.last_job)">
               Harvest not yet running
             </py:if>
            </td>
        </tr>
        <tr>
            <th>Next harvest</th>
            <td>
              <py:if test="c.source.next_run">
                Next automatic run: ${h.render_datetime(c.source.next_run, with_hours=True)}
              </py:if>
              <py:if test="c.source.status.next_harvest_job">
                Scheduled to start within 10 minutes
              </py:if>
            </td>
        </tr>
        <tr>
            <th>Total Datasets (from all harvests)</th>
            <td>${c.source.status.total_datasets}</td>
        </tr>
        </py:if>
        <tr>
            <th>Datasets</th>
            <td>
                <a name="datasets"/>
                <div py:if="job_detail">There could be a 10 minutes delay before these datasets (or changes to them) appear on
                the site or on search results.</div>

                <p i18n:msg="item_count">There are <strong>${c.page.item_count}</strong> datasets.</p>

                <py:for each="item in c.page.items">
                <div>
                <a href="/dataset/${item}">${item}</a>
                </div>
                </py:for>
                ${paginator(c.page)}

            </td>
        </tr>
    </table>
    </py:if>
  </div>
</div>
<xi:include href="../layout.html" />
</html>
